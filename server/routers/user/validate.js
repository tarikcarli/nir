import { sendMail } from "../../utils/email.js";
import { pQuery } from "../../utils/postgres.js";
import { sendResponse } from "../../utils/sendResponse.js";
import crypto from "crypto";

async function validate(req, res) {
  try {
    const {
      rows: [user],
    } = await pQuery({
      sql: "select * from users where email = $1;",
      // @ts-ignore
      parameters: [req.body.email],
    });
    if (!user) {
      throw new Error("There are no users associate about email");
    }
    const validateHash = crypto.randomBytes(20).toString("hex");
    await pQuery({
      sql: "insert into user_hashes(id, user_id, hash) values (default,$1, $2);",
      parameters: [user.id, validateHash],
    });
    const validateURL = `${process.env.SERVICE_URL}/api/user/validate?hash=${validateHash}`;
    await sendMail(
      `<style>a:link { color: #e2e8f0; } a:visited { color: #CBD5E0; } a:hover { color: #F7FAFC; background-color: #4A5568} a:active { color: #CBD5E0; } </style> <div style="font-family: sans-serif; min-width: 100%; min-height: 100vh; background-color:#1A202C; 	padding-top: 2rem; padding-bottom: 2rem; padding-right: 1rem; padding-left: 1rem;	-webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;"> <div style="	margin-right: auto;margin-left: auto;max-width: 28rem;"> <div style="background-color:#2D3748; padding: 2rem;overflow:hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);border-radius: 0.375rem;"> <div style="height: 8rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align:center; letter-spacing: 0.025em;	margin-right: -2rem;  margin-left: -2rem;margin-top: -2rem;background-size: cover;"> <div style="width: 100%; height: 100%; display:flex; flex: 1 1 0%;align-items: center; justify-content: center;"> <div style="margin:auto; color: #e2e8f0; "><svg style="width: 5rem;" viewBox="0 0 160 103" fill="none" xmlns="http://www.w3.org/2000/svg"> <g clip-path="url(#clip0)"> <path d="M13.17 97.53C13.4704 97.8389 13.8318 98.0819 14.2312 98.2437C14.6306 98.4055 15.0592 98.4826 15.49 98.47C15.9082 98.4852 16.3249 98.41 16.7115 98.2495C17.098 98.089 17.4454 97.847 17.73 97.54C18.3287 96.849 18.6369 95.9531 18.59 95.04V85.37H22.89V95C22.921 96.307 22.6108 97.5995 21.99 98.75C21.3963 99.8153 20.4978 100.679 19.41 101.23C18.1892 101.832 16.8409 102.131 15.48 102.1C14.096 102.136 12.7238 101.838 11.48 101.23C10.3775 100.681 9.46225 99.8184 8.84996 98.75C8.23934 97.5974 7.94599 96.3032 7.99995 95V85.37H12.3V95C12.2669 95.4586 12.327 95.9191 12.4765 96.3539C12.626 96.7887 12.8619 97.1887 13.17 97.53V97.53Z" fill="#E2E8F0" /> <path d="M55.6899 101.83L54.5599 98.92H47.4499L46.2999 101.83H41.8799L48.9499 85.37H53.3599L60.2599 101.83H55.6899ZM48.7399 95.63H53.2899L50.9999 89.76L48.7399 95.63Z" fill="#E2E8F0" /> <path d="M88.4499 89.06C87.6469 88.7684 86.8036 88.6031 85.9499 88.57C85.5109 88.5448 85.0738 88.6454 84.6899 88.86C84.5462 88.9522 84.4285 89.0796 84.348 89.2301C84.2675 89.3807 84.2268 89.5493 84.2299 89.72C84.2272 89.8901 84.2615 90.0587 84.3306 90.2141C84.3997 90.3696 84.5018 90.5081 84.6299 90.62C84.9224 90.8789 85.2619 91.0792 85.6299 91.21C86.0233 91.3567 86.6033 91.55 87.3699 91.79C88.3343 92.0606 89.2797 92.3946 90.1999 92.79C90.9513 93.1283 91.6074 93.647 92.1099 94.3C92.6706 95.0703 92.9527 96.0083 92.9099 96.96C92.9223 97.9649 92.6024 98.9457 91.9999 99.75C91.39 100.549 90.5641 101.156 89.6199 101.5C88.543 101.904 87.4002 102.104 86.2499 102.09C84.8621 102.084 83.4856 101.84 82.1799 101.37C80.8978 100.923 79.7083 100.245 78.6699 99.37L80.3399 96.01C81.2149 96.7743 82.2121 97.3862 83.2899 97.82C84.2351 98.2455 85.254 98.4832 86.2899 98.52C86.8162 98.5477 87.3396 98.4264 87.7999 98.17C87.9707 98.0656 88.1113 97.9184 88.2077 97.743C88.3042 97.5677 88.3532 97.3701 88.3499 97.17C88.3539 96.9929 88.3193 96.8172 88.2485 96.6548C88.1777 96.4925 88.0724 96.3475 87.9399 96.23C87.649 95.9665 87.3093 95.7627 86.9399 95.63C86.5266 95.4833 85.9433 95.3067 85.1899 95.1C84.238 94.8312 83.3058 94.4971 82.3999 94.1C81.66 93.7752 81.011 93.2739 80.5099 92.64C79.9535 91.8948 79.6741 90.9789 79.7199 90.05C79.7002 89.0936 79.9837 88.1554 80.5299 87.37C81.1115 86.5721 81.9097 85.9578 82.8299 85.6C83.9354 85.1719 85.1149 84.968 86.2999 85C87.491 84.9991 88.6762 85.1674 89.8199 85.5C90.8963 85.8007 91.9236 86.2554 92.8699 86.85L91.2499 90.28C90.3623 89.7756 89.4237 89.3667 88.4499 89.06Z" fill="#E2E8F0" /> <path d="M117.06 80.26C117.456 80.699 117.675 81.269 117.675 81.86C117.675 82.451 117.456 83.021 117.06 83.46C116.857 83.6669 116.614 83.8296 116.346 83.9381C116.077 84.0465 115.789 84.0982 115.5 84.09C115.207 84.0998 114.916 84.0488 114.644 83.9404C114.372 83.832 114.126 83.6684 113.92 83.46C113.52 83.0231 113.298 82.4523 113.298 81.86C113.298 81.2677 113.52 80.6969 113.92 80.26C114.127 80.0549 114.375 79.8941 114.646 79.7875C114.918 79.6809 115.208 79.6307 115.5 79.64C115.789 79.6311 116.076 79.6815 116.344 79.7882C116.613 79.8948 116.856 80.0554 117.06 80.26V80.26ZM113.33 85.37H117.63V101.83H113.33V85.37Z" fill="#E2E8F0" /> <path d="M147.6 89.06C146.797 88.7685 145.954 88.6032 145.1 88.57C144.661 88.5448 144.224 88.6454 143.84 88.86C143.696 88.9522 143.578 89.0796 143.498 89.2301C143.417 89.3807 143.377 89.5493 143.38 89.72C143.377 89.8901 143.411 90.0587 143.481 90.2141C143.55 90.3696 143.652 90.5081 143.78 90.62C144.072 90.8789 144.412 91.0792 144.78 91.21C145.173 91.3567 145.753 91.55 146.52 91.79C147.484 92.0605 148.43 92.3945 149.35 92.79C150.101 93.1283 150.757 93.647 151.26 94.3C151.82 95.0706 152.102 96.0084 152.06 96.96C152.088 97.9671 151.782 98.9552 151.19 99.77C150.58 100.568 149.754 101.175 148.81 101.52C147.733 101.924 146.59 102.124 145.44 102.11C144.052 102.104 142.676 101.86 141.37 101.39C140.088 100.943 138.898 100.265 137.86 99.39L139.53 96.03C140.405 96.7943 141.402 97.4062 142.48 97.84C143.425 98.2655 144.444 98.5032 145.48 98.54C146.006 98.5678 146.529 98.4464 146.99 98.19C147.161 98.0856 147.301 97.9384 147.398 97.763C147.494 97.5877 147.543 97.3901 147.54 97.19C147.544 97.013 147.509 96.8372 147.438 96.6748C147.368 96.5125 147.262 96.3675 147.13 96.25C146.839 95.9865 146.499 95.7827 146.13 95.65C145.717 95.5033 145.133 95.3267 144.38 95.12C143.428 94.8513 142.496 94.5171 141.59 94.12C140.85 93.7952 140.201 93.2939 139.7 92.66C139.143 91.9148 138.864 90.9989 138.91 90.07C138.89 89.1135 139.174 88.1754 139.72 87.39C140.301 86.5921 141.1 85.9778 142.02 85.62C143.121 85.1864 144.297 84.9757 145.48 85C146.671 84.9991 147.856 85.1674 149 85.5C150.062 85.8208 151.072 86.2923 152 86.9L150.38 90.33C149.501 89.8096 148.569 89.3839 147.6 89.06V89.06Z" fill="#E2E8F0" /> <path d="M44.81 0C38.0115 10.1424 32.2651 20.9516 27.66 32.26C18.0502 26.7265 8.8107 20.5735 0 13.84L0 6.3C0 4.62914 0.663748 3.02671 1.84523 1.84523C3.02671 0.663748 4.62914 0 6.3 0L44.81 0Z" fill="#E2E8F0" /> <path d="M132.11 13.67C129.528 19.9 127.307 26.2739 125.46 32.76C122.681 42.4688 120.563 52.3548 119.12 62.35H103.12L99.86 61.5C83.2818 57.0991 67.0859 51.3671 51.43 44.36C45.51 41.74 39.64 38.84 33.51 35.52C38.3774 23.3777 44.6072 11.8271 52.08 1.09L52.84 0H101.42L105 1.93C111.093 5.1857 117.37 8.08393 123.8 10.61C126.46 11.64 129.18 12.65 132.11 13.67Z" fill="#E2E8F0" /> <path d="M138.43 0L138.31 0.24C136.96 2.88 135.82 5.24 134.75 7.55C131.75 6.5 128.92 5.47 126.24 4.42C122.83 3.09 119.47 1.64 116 0H138.43Z" fill="#E2E8F0" /> <path d="M160 6.30001V14.67C153.82 13.36 147.46 11.67 141.08 9.67001C142.27 7.09001 143.56 4.49001 145.18 1.41001L145.91 0.0100098H153.7C155.369 0.0100077 156.97 0.672383 158.151 1.8517C159.333 3.03102 159.997 4.63088 160 6.30001V6.30001Z" fill="#E2E8F0" /> <path d="M160 21.44V56.05C160 57.7209 159.336 59.3233 158.155 60.5048C156.973 61.6863 155.371 62.35 153.7 62.35H125.82C127.213 52.9725 129.217 43.6961 131.82 34.58C133.639 28.191 135.829 21.9137 138.38 15.78C145.481 18.0504 152.698 19.9398 160 21.44V21.44Z" fill="#E2E8F0" /> <path d="M25.25 38.52C22.3502 46.3223 19.8798 54.2775 17.85 62.35H6.3C5.47267 62.35 4.65345 62.187 3.88909 61.8704C3.12474 61.5538 2.43024 61.0898 1.84523 60.5048C1.26022 59.9198 0.796164 59.2252 0.479559 58.4609C0.162954 57.6965 0 56.8773 0 56.05L0 22.05C8.09501 28.018 16.5255 33.517 25.25 38.52V38.52Z" fill="#E2E8F0" /> <path d="M79.5199 62.35H24.7L24.86 61.73C24.91 61.52 24.97 61.31 25.02 61.1L25.08 60.88C26.76 54.59 28.79 48.18 31.08 41.77C37.08 45.01 42.8599 47.84 48.6899 50.42C58.9499 55 69.2799 59 79.5199 62.35Z" fill="#E2E8F0" /> </g> <defs> <clipPath id="clip0"> <rect width="160" height="102.13" fill="white" /> </clipPath> </defs> </svg> </div> </div> </div> <div style="padding-top: 2rem; padding-bottom: 2rem; border-top: 1px solid #a0aec0; border-bottom: 1px solid #a0aec0; color: #e2e8f0;"> <p> Merhaba,<br><br> Kullanıcı kaydını tamamlamak için <a href=${validateURL} style="text-decoration: underline;transition-property: background-color, border-color, color, fill, stroke;transition-timing-function: cubic-bezier(0.4, 0, 1, 1);transition-duration: 100ms;cursor: pointer;"> buradaki</a> bağlantıya tıklayabilir veya aşağıdaki bağlantıyı kopyalayıp tarayıcınızda açabilirsiniz.<br><br> </p> <p style="word-break: break-all">${validateURL}</p> </div> <div style="margin-top: 2rem;text-align:center; color: #e2e8f0;"> <h3 style="font-size: 1rem; margin-bottom:1rem">Kayıt olduğunuz için teşekkür ederiz.</h3> <a style="text-decoration: underline;" href="www.bilengoz.com" alt="UASİS Ana Sayfa">www.bilengoz.com</a> </div> </div> </div> </div>`,
      validateURL,
      req.body.email,
      "Verification mail"
    );
    sendResponse({ req, res, responseData: {}, logRequest: false, logResponse: false });
  } catch (err) {
    sendResponse({ err, req, res, logRequest: false });
  }
}
export { validate };
